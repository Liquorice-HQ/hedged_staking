# Hedged staking strategy

# Introduction

This document describes a passive hedged staking strategy implemented in Rust. This strategy uses a centralized staking provider on the one hand and a decentralized hedge on the other. The strategy aims to be fully decentralized in the next iterations. As an example, in this repo, we use $ATOM tokens to earn staking rewards and hedge the market risk of the $ATOM price through the dYdX decentralized exchange. For the sake of simplicity, we are staking tokens through the Kraken exchange. This allows us to avoid waiting time for the unbonding period and receive tokens instantly when we request to unbond through the Kraken. Strategy also allows for intermediate counterparty to exchange $ATOM tokens to USDC. We use Binance as an intermediate.

# Setup and running

The strategy is configured using the `config.toml` file.

## `config.toml`:

```toml
[kraken]
# Kraken credentials
key = "..."
secret = "..."

[dydx]
# dYdX credentials:
key = "00000000-0000-0000-0000-000000000000"
secret = "..."
passphrase = "..."
stark_private_key = "..."

[wallet]
# ETH address in which USDC based:
eth_address = "0x..."
eth_private_key = "..."
```

Kraken API keys can be generated through Account (top right) -> Security -> API. You need access to request
funds, order management, write-offs.

The strategy operates the intermediate wallet directly. It is need to specify the ETH wallet address and the private key.
They will be used to move USDC between Binance, Kraken and dYdX.

Access to dYdX is carried out through keys generated by dYdX, so you have to
extract them from the browser, where they are stored in the Local Storage of the appropriate site. To do this you need to open the developer panel
(usually in many browsers for this press `F11`), go to the tab Storage, then to the section Local Storage, select the
site `https://trade.dydx.exchange`, then find the two keys:
* `API_KEY_PAIRS`, and take from there the value of `key`, `secret`, `passphrase`.
* `STARK_KEY_PAIRS`, and take from there the value of `privateKey`, put it in `stark_private_key`.

In the next iterations, we plan to generate the necessary keys based on the ETH address/key.

## Running

The module allows you to run both the entire strategy and individual actions:

```console
% cargo lrun -- --help
hedged_staking 0.0.4
Hedged staking

USAGE:
    hedged_staking [CONFIG] <SUBCOMMAND>

ARGS:
    <CONFIG>

OPTIONS:
    -h, --help       Print help information
    -V, --version    Print version information

SUBCOMMANDS:
    help    Print this message or the help of the given subcommand(s)
    only    Run only specified action
    run     Run main strategy
```

Example of running one action:

```bash
cargo lrun -- only do_wallet_transfer_to_dydx
```

Running the whole strategy:

```bash
cargo lrun -- run
```

# Overview of the module

Module contains of several "actions" (see [src/strategy.rs](src/strategy.rs)). "Action" -- is a function (with name
prefixed `do_`) which do elementary action on one of account (like "exchange USDC to ATOM" or transfer ATOMs from Kraken
to Binance). Example:

```rust
/// Stake all staked assets
///
pub async fn do_stake(ctx: &mut Context) -> Result<(), StrategyError> {
    debug!("do_unstake: {:?}", ctx.balances);
    stake_unstake_impl(ctx, true).await
}
```

To avoid overloading the [src/strategy.rs](src/strategy.rs) file, almost all interaction with exchanges was moved to [src/helpers.rs](src/helpers.rs).

Actions can be run individually, for example, `cargo lrun -- only do_wallet_transfer_to_dydx`. This feature is needed for debugging individual actions. The function [run_action_by_name()] (src/strategy.rs#L507), which is generated with the function is generated using the [update-action-names.hs](./update-action-names.hs) script.


## Workflow:

1. Initialization:
   1. Read the balances on each of the exchanges.
   1. Check their consistency (e.g., if the last state is "tokens on dYdX in short position" and balances on dYdX are not detected, then it is obviously a mistake).
1. Regular state. Let the initial state be "all tokens in the intermediate wallet", then cyclically the following actions will be performed:
   1. Transfer $ATOM to Kraken.
   1. Stake ATOMs.
   1. Transfer USDC to dYdX (for the moment with human operator).
   1. Wait for USDC to appear on dYdX (balance should increase)
   1. Take a short position vs staked $ATOM
   1. If the $ATOM price drops, transfer USDC from dYdX to the wallet and then to Binance to buy $ATOM and then to Kraken stake it; continue waiting.
   1. If $ATOM price rises, unbond some $ATOM, sell it for USDC on Binance then withdraw USDC to dYdX; continue waiting.

## Monitoring:

At the moment, logs are displayed on the screen (INFO, WARNING and ERROR levels), and stored to a file.

Every activity triggers balance check and log record. Check occurs once in a minute, and the current balance is written in the logs.

Notifications are also available in Telegram and via Prometheus.
